name: Build & Test

on: [push]

jobs:
  Ubuntu-1604:
    runs-on: ubuntu-16.04
    steps:
    - uses: actions/checkout@v1
    - name: apt
      run: sudo apt install ruby gperf bison
    - name: build and test
      run: ./minirake -j4 all test
      env:
        MRUBY_CONFIG: travis_config.rb

  Ubuntu-1804-gcc:
    runs-on: ubuntu-18.04
    steps:
    - uses: actions/checkout@v1
    - name: apt
      run: sudo apt install ruby gperf bison gcc g++
    - name: build and test
      run: ./minirake -j4 all test
      env:
        MRUBY_CONFIG: travis_config.rb
        CC: gcc
        CXX: g++

  Ubuntu-1804-clang:
    runs-on: ubuntu-18.04
    steps:
    - uses: actions/checkout@v1
    - name: apt
      run: sudo apt install ruby gperf bison
    - name: build and test
      run: ./minirake -j4 all test
      env:
        MRUBY_CONFIG: travis_config.rb
        CC: clang
        CXX: clang++

  macOS:
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v1
    - name: brew
      run: brew install ruby gperf bison
    - name: build and test
      run: ruby ./minirake -j4 all test
      env:
        MRUBY_CONFIG: travis_config.rb

  Windows-MinGW:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v1
    - name: chocolatey
      run: choco install -y ruby winflexbison gperf 
    - name: build and test
      run: rake -E '$stdout.sync=true' -v test
      env:
        MRUBY_CONFIG: travis_config.rb
        YACC: win_bison
        LDFLAGS: -fno-asynchronous-unwind-tables
        CFLAGS: -g -O0 -Wall -Wundef

  Windows-VC:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v1
    - name: chocolatey
      run: choco install -y ruby winflexbison gperf
    - name: build and test
      run: |
        "C:\Program Files (x86)\Microsoft Visual Studio\2017\Enterprise\VC\Auxiliary\Build\vcvars64.bat" %machine%
        rake -E '$stdout.sync=true' -v test
      env:
        MRUBY_CONFIG: appveyor_config.rb
        YACC: win_bison
